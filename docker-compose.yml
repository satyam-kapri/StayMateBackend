version: "3.8"

services:
  # 1. Your Node.js Application (UNCHANGED)
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    expose:
      - "3000"
    environment:
      DATABASE_URL: ${DATABASE_URL}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION}
      AWS_BUCKET_NAME: ${AWS_BUCKET_NAME}
      JWT_SECRET: ${JWT_SECRET}
      PORT: 3000
    restart: always
    networks:
      - app_network

  # 2. Prisma Migrations (UNCHANGED)
  migrations:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL}
    command: npx prisma migrate deploy
    networks:
      - app_network
    profiles:
      - migrate

  # 3. HTTPS Portal (REPLACES your Nginx service)
  https-portal:
    image: steveltn/https-portal:1
    ports:
      - "80:80"
      - "443:443" # HTTPS port
    environment:
      # ðŸ‘‡ CHANGE THIS IP to your actual AWS Public IP ðŸ‘‡
      DOMAINS: "13.203.41.42.nip.io -> http://backend:3000"
      WEBSOCKET: "true"
      # 'production' gives you a real green lock.
      STAGE: "production"
    volumes:
      - https-portal-data:/var/lib/https-portal
    depends_on:
      - backend
    networks:
      - app_network

# 4. Define a shared network
networks:
  app_network:
    driver: bridge

# 5. Volume for certificate storage
volumes:
  https-portal-data:
