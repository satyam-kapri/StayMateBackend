version: "3.8"

services:
  # 1. Your Node.js Application
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    # REMOVED: ports: "3000:3000" (We don't want the world accessing this directly)
    expose:
      - "3000" # Only exposes port to Nginx, not the public internet
    environment:
      DATABASE_URL: ${DATABASE_URL}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION}
      AWS_BUCKET_NAME: ${AWS_BUCKET_NAME}
      JWT_SECRET: ${JWT_SECRET}
      PORT: 3000
    restart: always
    networks:
      - app_network

  # 2. Prisma Migrations (Runs once then stops)
  migrations:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL}
    # Using 'deploy' makes sure it doesn't ask for user input
    command: npx prisma migrate deploy
    networks:
      - app_network
    # Optional: If you remove 'profiles', it runs every time you 'up'. 
    # If you keep 'profiles', you must run: docker compose --profile migrate up
    profiles:
      - migrate 

  # 3. Nginx Reverse Proxy
  nginx:
    image: nginx:latest
    ports:
      - "80:80"
    restart: always
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend
    networks:
      - app_network

# 4. Define a shared network
networks:
  app_network:
    driver: bridge
